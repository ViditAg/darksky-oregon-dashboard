<!-- flask_api/templates/index.html -->
{% extends "base.html" %}

{% block content %}
<!-- Control Panel -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Dashboard Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Measurement Type:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="nightType" id="clearNights" value="clear" checked>
                            <label class="form-check-label" for="clearNights">Clear Nights</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="nightType" id="cloudyNights" value="cloudy">
                            <label class="form-check-label" for="cloudyNights">Cloudy Nights</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="metricSelect" class="form-label fw-bold">Bar Chart Metric:</label>
                        <select class="form-select" id="metricSelect">
                            <option value="brightness" selected>Sky Brightness</option>
                            <option value="bortle">Bortle Scale</option>
                            <option value="pollution_ratio">Light Pollution Ratio</option>
                            <option value="annual_change">Annual Change (%)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Sort Order:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="sortOrder" id="sortDesc" value="desc" checked>
                            <label class="form-check-label" for="sortDesc">Best to Worst</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="sortOrder" id="sortAsc" value="asc">
                            <label class="form-check-label" for="sortAsc">Worst to Best</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-primary" id="totalSites">-</h4>
                <p class="text-muted mb-0">Total Sites</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-success" id="darkestSky">-</h4>
                <p class="text-muted mb-0">Darkest Sky</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-info" id="certifiedSites">-</h4>
                <p class="text-muted mb-0">Certified Sites</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-warning" id="avgChange">-</h4>
                <p class="text-muted mb-0">Avg Change</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Visualizations -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üó∫Ô∏è Interactive Oregon Map</h5>
            </div>
            <div class="card-body">
                <div id="oregonMap" style="height: 600px;"></div>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Legend:</strong>
                        üü¶ Pristine (‚â•21.5) | üü¢ Excellent (‚â•21.2) | üü° Good (‚â•20.0) | üü† Fair (‚â•19.0) | üî¥ Poor (<19.0)
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìä Site Rankings</h5>
            </div>
            <div class="card-body">
                <div id="rankingChart" style="height: 600px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìã Site Data Explorer</h5>
                <div class="d-flex gap-3">
                    <input type="text" id="siteSearch" class="form-control" placeholder="Search sites..." style="width: 200px;">
                    <button class="btn btn-outline-primary btn-sm" id="refreshData">Refresh</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="sitesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Site Name</th>
                                <th>Brightness (mag/arcsec¬≤)</th>
                                <th>Bortle Scale</th>
                                <th>Dark Sky Status</th>
                                <th>Region</th>
                                <th>Coordinates</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard JavaScript functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dashboard
    updateDashboard();
    
    // Event listeners
    document.querySelectorAll('input[name="nightType"]').forEach(radio => {
        radio.addEventListener('change', updateDashboard);
    });
    
    document.getElementById('metricSelect').addEventListener('change', updateRankingChart);
    
    document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
        radio.addEventListener('change', updateRankingChart);
    });
    
    document.getElementById('siteSearch').addEventListener('input', debounce(updateSitesTable, 300));
    document.getElementById('refreshData').addEventListener('click', updateDashboard);
});

function updateDashboard() {
    updateMetrics();
    updateMap();
    updateRankingChart();
    updateSitesTable();
}

function updateMetrics() {
    const nightType = document.querySelector('input[name="nightType"]:checked').value;
    
    fetch(`/api/metrics?night_type=${nightType}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalSites').textContent = data.total_sites || '-';
            document.getElementById('darkestSky').textContent = 
                data.darkest_brightness ? `${data.darkest_brightness.toFixed(2)} mag/arcsec¬≤` : 'N/A';
            document.getElementById('certifiedSites').textContent = data.certified_sites || '-';
            document.getElementById('avgChange').textContent = 
                data.avg_annual_change ? `${data.avg_annual_change.toFixed(1)}%` : 'N/A';
        })
        .catch(error => console.error('Error updating metrics:', error));
}

function updateMap() {
    const nightType = document.querySelector('input[name="nightType"]:checked').value;
    
    fetch(`/api/map?night_type=${nightType}`)
        .then(response => response.json())
        .then(fig => {
            Plotly.newPlot('oregonMap', fig.data, fig.layout, {responsive: true});
        })
        .catch(error => console.error('Error updating map:', error));
}

function updateRankingChart() {
    const nightType = document.querySelector('input[name="nightType"]:checked').value;
    const metric = document.getElementById('metricSelect').value;
    const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
    
    fetch(`/api/ranking?night_type=${nightType}&metric=${metric}&sort_order=${sortOrder}`)
        .then(response => response.json())
        .then(fig => {
            Plotly.newPlot('rankingChart', fig.data, fig.layout, {responsive: true});
        })
        .catch(error => console.error('Error updating ranking chart:', error));
}

function updateSitesTable() {
    const nightType = document.querySelector('input[name="nightType"]:checked').value;
    const search = document.getElementById('siteSearch').value;
    
    fetch(`/api/sites?night_type=${nightType}&search=${search}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#sitesTable tbody');
            tbody.innerHTML = '';
            
            data.sites.forEach(site => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${site.site_name}</strong></td>
                    <td>${site.median_brightness_mag_arcsec2 ? site.median_brightness_mag_arcsec2.toFixed(2) : 'N/A'}</td>
                    <td>${site.bortle_scale || 'N/A'}</td>
                    <td><span class="badge ${site.dark_sky_status !== 'None' ? 'bg-success' : 'bg-secondary'}">${site.dark_sky_status}</span></td>
                    <td>${site.region}</td>
                    <td>${site.latitude && site.longitude ? `${site.latitude.toFixed(3)}, ${site.longitude.toFixed(3)}` : 'N/A'}</td>
                `;
            });
        })
        .catch(error => console.error('Error updating sites table:', error));
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}